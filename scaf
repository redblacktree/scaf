#!/usr/bin/env bash

# Default repository URL if none is provided
DEFAULT_REPO_URL="https://github.com/sixfeetup/scaf/"

# Ensure at least one argument is provided (for project_slug)
if [ $# -lt 1 ]; then
  echo "Usage: scaf project_slug [OPTIONS] [TEMPLATE]"
  exit 1
fi

# The first argument is always the project slug
PROJECT_SLUG="$1"

# Validate the project slug
if ! [[ $PROJECT_SLUG =~ ^[a-zA-Z0-9]+$ ]]; then
    echo "Error: PROJECT_SLUG should only contain alphanumeric characters."
    exit 1
fi

# Remove the project_slug from the argument list
shift

# Assume the last argument is the template URL unless it starts with a dash
if [ $# -gt 0 ]; then
  LAST_ARG="${@: -1}"
  if [[ $LAST_ARG == -* ]]; then
    REPO_URL="$DEFAULT_REPO_URL"
    COOKIECUTTER_OPTIONS="$@"
  else
    REPO_URL="$LAST_ARG"
    # Remove the last argument (the REPO_URL) from the options
    COOKIECUTTER_OPTIONS="${@:1:$(($#-1))}"
  fi
else
  REPO_URL="$DEFAULT_REPO_URL"
  COOKIECUTTER_OPTIONS=""
fi

echo "COOKIECUTTER_OPTIONS: $COOKIECUTTER_OPTIONS"
echo "REPO_URL: $REPO_URL"

cookiecutter \
  $COOKIECUTTER_OPTIONS \
  $REPO_URL \
  project_slug="$PROJECT_SLUG"

# Check if cookiecutter was successful
if [ $? -eq 0 ]; then
    kind create cluster --name $PROJECT_SLUG
else
    echo "Failed to create project."
    exit 1
fi
